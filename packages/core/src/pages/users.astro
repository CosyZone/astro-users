---
import type { UserRecord, UserQueryResult } from '../types/user';
import { UsersQuery } from '../lib/users';
import { Button, Container, Heading, Link } from '@coffic/cosy-ui';
import DashboardLayout from './layout/DashboardLayout.astro';
import UserFilter from '../components/UserFilter.astro';
import UserList from '../components/UserList.astro';

export const prerender = false;

// 创建查询实例
const usersQuery = new UsersQuery(Astro.locals);

// 获取查询参数
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1');
const limit = parseInt(url.searchParams.get('limit') || '10');
const usernameFilter = url.searchParams.get('username') || undefined;
const roleFilter = url.searchParams.get('role') || undefined;

// 查询数据
const users: UserQueryResult = await usersQuery.getUsers({
    page,
    limit,
    sortBy: 'created_at',
    sortOrder: 'desc',
    filters: {
        username: usernameFilter,
        role: roleFilter,
    },
});
---

<DashboardLayout title="用户管理" description="用户管理页面" lang="zh-cn">
    <Container width="full" background="none" flex="col" gap="xl">
        <Heading level={1}>用户管理</Heading>

        <!-- 筛选表单 -->
        <UserFilter
            usernameFilter={usernameFilter}
            roleFilter={roleFilter}
            limit={limit}
        />

        <!-- 用户表格 -->
        <UserList
            users={users}
            usernameFilter={usernameFilter}
            roleFilter={roleFilter}
            limit={limit}
        />
    </Container>
</DashboardLayout>
<style>
    .filter-form {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .filter-form input,
    .filter-form select,
    .filter-form button {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 14px;
    }

    .filter-form button {
        background: #2563eb;
        color: white;
        cursor: pointer;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .users-table th,
    .users-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }

    .users-table th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
    }

    .users-table tr:hover {
        background-color: #f9fafb;
    }

    .username-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }
</style>
