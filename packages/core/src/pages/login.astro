---
import { UsersQuery } from '../lib/users';
import AppLayout from './layout/AppLayout.astro';
import { Alert, Button, Container, Heading, Link } from '@coffic/cosy-ui';

export const prerender = false;

// 处理表单提交
let loginError: string | null = null;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const usersQuery = new UsersQuery(Astro.locals);

    const username = formData.get('username') as string;
    const password = formData.get('password') as string;

    // 验证必填字段
    if (!username || !password) {
      loginError = '用户名和密码是必填的';
    } else {
      // 验证用户凭据
      const user = await usersQuery.validateUserCredentials(username, password);

      if (user) {
        // 登录成功，重定向到用户列表页面
        return Astro.redirect('/users');
      } else {
        loginError = '用户名或密码错误';
      }
    }
  } catch (error) {
    console.error('用户登录错误:', error);
    loginError = '登录过程中发生错误: ' + (error as Error).message;
  }
}
---

<AppLayout title="用户登录" description="登录到用户账户" showSidebar={false}>
  <Container width="md" background="accent/10">
    <Heading level={1}>用户登录</Heading>

    <div class="login-container">
      {loginError && <Alert type="error">{loginError}</Alert>}

      <form method="POST" class="login-form">
        <div class="form-group">
          <label for="username">用户名</label>
          <input type="text" id="username" name="username" required />
        </div>

        <div class="form-group">
          <label for="password">密码</label>
          <input type="password" id="password" name="password" required />
        </div>

        <div class="form-actions">
          <Button type="submit" variant="primary">登录</Button>
          <Link href="/signup" btn>注册新账户</Link>
        </div>
      </form>
    </div>
  </Container>
</AppLayout>

<style>
  .login-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin: 20px 0;
    max-width: 400px;
  }

  .login-form {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-group label {
    margin-bottom: 5px;
    font-weight: 500;
  }

  .form-group input {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
  }

  .form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-start;
    margin-top: 10px;
  }
</style>
