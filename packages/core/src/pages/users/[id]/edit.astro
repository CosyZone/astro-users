---
import type { UserRecord } from '../../../types/user';
import { UsersQuery } from '../../../lib/users';
import AppLayout from '../../layout/AppLayout.astro';
import { Alert, Button, Container, Heading, Link } from '@coffic/cosy-ui';

export const prerender = false;

// 获取用户ID
const { id } = Astro.params;
const userId = parseInt(id || '0');

if (isNaN(userId)) {
    throw new Error('Invalid user ID');
}

// 创建查询实例
const usersQuery = new UsersQuery(Astro.locals);

// 获取用户信息
const user: UserRecord | null = await usersQuery.getUserById(userId);

if (!user) {
    throw new Error('User not found');
}

// 处理表单提交
let updateError: string | null = null;
let updateSuccess = false;

if (Astro.request.method === 'POST') {
    try {
        const formData = await Astro.request.formData();

        const username = formData.get('username') as string;
        const email = formData.get('email') as string;
        const firstName = (formData.get('first_name') as string) || null;
        const lastName = (formData.get('last_name') as string) || null;
        const avatarUrl = (formData.get('avatar_url') as string) || null;
        const role = (formData.get('role') as string) || 'user';
        const isActive = formData.get('is_active') === 'on';
        const password = (formData.get('password') as string) || undefined;

        // 准备更新数据
        const updateData: Partial<
            Omit<UserRecord, 'id' | 'created_at' | 'updated_at'>
        > = {
            username,
            email,
            first_name: firstName,
            last_name: lastName,
            avatar_url: avatarUrl,
            role,
            is_active: isActive === true,
        };

        // 只有当提供了新密码时才更新密码
        if (password && password.length > 0) {
            updateData.password = password;
        }

        const updatedUser = await usersQuery.updateUser(userId, updateData);

        if (updatedUser) {
            updateSuccess = true;
            updateError = null;
        } else {
            updateError = '更新用户失败';
        }
    } catch (error) {
        console.error('Update user error:', error);
        updateError = '更新用户时发生错误: ' + (error as Error).message;
    }
}
---

<AppLayout
    title={`编辑用户 - ${user.username}`}
    description={`编辑用户 ${user.username} 的信息`}>
    <Container width="xl" background="accent/10">
        <Heading level={1}>编辑用户</Heading>

        <div class="edit-user-page">
            <div class="form-container">
                {
                    updateSuccess && (
                        <Alert type="success">用户信息更新成功！</Alert>
                    )
                }
                {updateError && <Alert type="error">{updateError}</Alert>}

                <form method="POST" class="edit-user-form">
                    <div class="form-group">
                        <label for="username">用户名 *</label>
                        <input
                            type="text"
                            id="username"
                            name="username"
                            value={user.username}
                            required
                        />
                    </div>

                    <div class="form-group">
                        <label for="email">邮箱 *</label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            value={user.email}
                            required
                        />
                    </div>

                    <div class="form-group">
                        <label for="first_name">名字</label>
                        <input
                            type="text"
                            id="first_name"
                            name="first_name"
                            value={user.first_name || ''}
                        />
                    </div>

                    <div class="form-group">
                        <label for="last_name">姓氏</label>
                        <input
                            type="text"
                            id="last_name"
                            name="last_name"
                            value={user.last_name || ''}
                        />
                    </div>

                    <div class="form-group">
                        <label for="avatar_url">头像URL</label>
                        <input
                            type="text"
                            id="avatar_url"
                            name="avatar_url"
                            value={user.avatar_url || ''}
                            placeholder="https://example.com/avatar.jpg"
                        />
                    </div>

                    <div class="form-group">
                        <label for="password">新密码（留空则不更改）</label>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            placeholder="留空则不更改密码"
                        />
                    </div>

                    <div class="form-group">
                        <label for="role">角色</label>
                        <select id="role" name="role">
                            <option value="user" selected={user.role === 'user'}
                                >普通用户</option
                            >
                            <option
                                value="admin"
                                selected={user.role === 'admin'}>管理员</option
                            >
                            <option
                                value="moderator"
                                selected={user.role === 'moderator'}
                                >版主</option
                            >
                        </select>
                    </div>

                    <div class="form-group checkbox">
                        <input
                            type="checkbox"
                            id="is_active"
                            name="is_active"
                            checked={user.is_active}
                        />
                        <label for="is_active">账户激活</label>
                    </div>

                    <div class="form-actions">
                        <Button type="submit" variant="primary">更新用户</Button
                        >
                        <Link href="/users" btn>取消</Link>
                    </div>
                </form>
            </div>
        </div>
    </Container>
</AppLayout>

<style>
    .edit-user-page {
        padding: 20px 0;
    }

    .form-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .edit-user-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        margin-bottom: 5px;
        font-weight: 500;
    }

    .form-group input,
    .form-group select {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-group.checkbox {
        flex-direction: row;
        align-items: center;
        gap: 8px;
    }

    .form-group.checkbox input {
        width: auto;
    }

    .form-actions {
        grid-column: span 2;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
</style>
