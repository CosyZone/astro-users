---
import type { UserRecord } from '../../../types/user';
import { UsersQuery } from '../../../lib/users';
import AppLayout from '../../layout/AppLayout.astro';
import UserDetail from '../../../components/UserDetail.astro';

export const prerender = false;

// 获取用户ID
const { id } = Astro.params;
const userId = parseInt(id || '0');

if (isNaN(userId)) {
    throw new Error('Invalid user ID');
}

// 创建查询实例
const usersQuery = new UsersQuery(Astro.locals);

// 获取用户信息
const user: UserRecord | null = await usersQuery.getUserById(userId);

if (!user) {
    throw new Error('User not found');
}
---

<AppLayout
    title={`用户详情 - ${user.username}`}
    description={`查看用户 ${user.username} 的详细信息`}>
    <div class="user-detail-page">
        <h1>用户详情</h1>
        <UserDetail user={user} />
    </div>
</AppLayout>

<script>
    // 添加删除用户的功能
    document.addEventListener('click', async (e: Event) => {
        const target = e.target as HTMLElement;
        if (target && target.matches('[data-action="delete"]')) {
            const userId = target.dataset.id;
            if (userId && confirm('确定要删除这个用户吗？此操作不可撤销。')) {
                try {
                    const response = await fetch(`/api/users/${userId}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        alert('用户删除成功');
                        window.location.href = '/users';
                    } else {
                        const result = await response.json();
                        alert('删除失败: ' + (result.error || '未知错误'));
                    }
                } catch (error: any) {
                    alert('删除失败: ' + (error.message || '未知错误'));
                }
            }
        }
    });
</script>

<style>
    .user-detail-page {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
    }
</style>
