---
import { UsersQuery } from '@coffic/astro-users';
import AppLayout from '../layout/AppLayout.astro';
import { Container } from '@coffic/cosy-ui';
import { LanguageUtil } from '@coffic/cosy-ui';
import CreateUserForm from '../components/CreateUserForm.astro';
import UserStats from '../components/UserStats.astro';
import UserFilter from '../components/UserFilter.astro';
import UserTable from '../components/UserTable.astro';
import Pagination from '../components/Pagination.astro';
import RoleStats from '../components/RoleStats.astro';

const lang = LanguageUtil.getCurrentLanguage(Astro);

export const prerender = false;

// åˆ›å»ºæŸ¥è¯¢å®ä¾‹ï¼ˆç›´æ¥ä¼ é€’ Astro.localsï¼‰
const usersQuery = new UsersQuery(Astro.locals);

// å¤„ç†åˆ›å»ºç”¨æˆ·è¡¨å•æäº¤
let createError: string | null = null;
let createSuccess = false;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'create') {
    try {
      const username = formData.get('username') as string;
      const email = formData.get('email') as string;
      const password = formData.get('password') as string;
      const firstName = (formData.get('first_name') as string) || undefined;
      const lastName = (formData.get('last_name') as string) || undefined;
      const avatarUrl = (formData.get('avatar_url') as string) || undefined;
      const role = (formData.get('role') as string) || 'user';
      const isActive = formData.get('is_active') === 'on';

      if (!username || !email || !password) {
        createError = 'ç”¨æˆ·åã€é‚®ç®±å’Œå¯†ç æ˜¯å¿…å¡«é¡¹';
      } else {
        const newUser = await usersQuery.createUser({
          username,
          email,
          password,
          first_name: firstName,
          last_name: lastName,
          avatar_url: avatarUrl,
          role,
          is_active: isActive,
        });

        if (newUser) {
          createSuccess = true;
          createError = null;
          // é‡å®šå‘ä»¥æ¸…é™¤è¡¨å•æ•°æ®
          return Astro.redirect('/admin');
        } else {
          createError = 'åˆ›å»ºç”¨æˆ·å¤±è´¥';
        }
      }
    } catch (error) {
      console.error('Create user error:', error);
      createError = 'åˆ›å»ºç”¨æˆ·æ—¶å‘ç”Ÿé”™è¯¯: ' + (error?.message || 'æœªçŸ¥é”™è¯¯');
    }
  }
}

// è·å–æŸ¥è¯¢å‚æ•°
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1');
const limit = parseInt(url.searchParams.get('limit') || '10');
const usernameFilter = url.searchParams.get('username') || undefined;
const roleFilter = url.searchParams.get('role') || undefined;

// æŸ¥è¯¢æ•°æ®
const users = await usersQuery.getUsers({
  page,
  limit,
  sortBy: 'created_at',
  sortOrder: 'desc',
  filters: {
    username: usernameFilter,
    role: roleFilter,
  },
});

// è·å–ç»Ÿè®¡æ•°æ®
const stats = await usersQuery.getStats();

// è·å–ç”¨æˆ·è§’è‰²ç»Ÿè®¡
const roleStats = stats.roles;
---

<AppLayout
  showSidebar={false}
  py="5xl"
  title="Astro Visits Integration Example"
  description="This example demonstrates the astro-visits integration.">
  <Container width="xl" margin="xl" py="xl">
    <CreateUserForm createSuccess={createSuccess} createError={createError} />

    <UserStats
      stats={{
        totalUsers: stats.totalUsers,
        activeUsers: stats.activeUsers,
        todayUsers: stats.todayUsers,
        totalPages: users.pagination.totalPages,
      }}
    />

    <UserFilter
      usernameFilter={usernameFilter}
      roleFilter={roleFilter}
      limit={limit}
    />

    <div class="section">
      <h2>ğŸ“‹ ç”¨æˆ·åˆ—è¡¨</h2>
      <p>
        æ˜¾ç¤ºç¬¬ {users.pagination.page} é¡µï¼Œå…± {users.pagination.totalPages} é¡µï¼Œæ€»è®¡
        {users.pagination.total} æ¡è®°å½•
      </p>

      <UserTable users={{ data: users.data }} />

      <Pagination
        users={users}
        limit={limit}
        usernameFilter={usernameFilter}
        roleFilter={roleFilter}
      />
    </div>

    <RoleStats roleStats={roleStats} />
  </Container>
</AppLayout>
